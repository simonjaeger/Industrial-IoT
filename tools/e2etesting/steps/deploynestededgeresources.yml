steps:
- task: DownloadPipelineArtifact@2
  inputs:
    artifact: 'testartifacts'
    path: $(BasePath)

- task: AzurePowerShell@5
  displayName: "Deploy ACR"
  timeoutInMinutes: 30
  inputs:
    azureSubscription: '$(AzureSubscription)'
    azurePowerShellVersion: 'latestVersion'
    scriptType: filePath
    scriptPath: '$(BasePath)\DeployAcr.ps1'
    scriptArguments: >
      -ResourceGroupName "$(ResourceGroupName)"

- task: AzureCLI@2
  displayName: 'Set IoT Hub name'
  inputs:
    azureSubscription: '$(AzureSubscription)'
    azurePowerShellVersion: 'latestVersion'
    scriptLocation: 'InlineScript'
    scriptType: 'ps'
    addSpnToEnvironment: true
    inlineScript: |
      Write-Host $(BasePath)
      Write-Host $(ResourceGroupName)
      Write-Host ${env:iothub}   
      $iotHubName = (Get-AzIotHub -ResourceGroupName $(ResourceGroupName)).Name
      Write-Host "##vso[task.setvariable variable=iothub]$iotHubName"
      Write-Host ${env:iothub}

- task: Bash@3
  inputs:
    filePath: '$(BasePath)\NestedEdge\install.sh'
    arguments: '-rg $(ResourceGroupName) -hubrg $(ResourceGroupName) -hubname $(iothub)'

- task: AzurePowerShell@5
  displayName: "Deploy containers with simulated PLCs"
  timeoutInMinutes: 90
  inputs:
    azureSubscription: '$(AzureSubscription)'
    azurePowerShellVersion: 'latestVersion'
    scriptType: filePath
    scriptPath: '$(BasePath)\DeployPLCs.ps1'
    scriptArguments: >
      -ResourceGroupName "$(ResourceGroupName)"

- task: AzurePowerShell@5
  displayName: "Deploy TestEventProcessor"
  timeoutInMinutes: 90
  inputs:
    azureSubscription: '$(AzureSubscription)'
    azurePowerShellVersion: 'latestVersion'
    scriptType: filePath
    scriptPath: '$(BasePath)\DeployTestEventProcessor.ps1'
    scriptArguments: >
      -ResourceGroupName "$(ResourceGroupName)"
      -PackageDirectory "$(BasePath)\TestEventProcessor"